# ğŸ›ï¸ Arquitectura del Sistema Ticketero

## ğŸ“‹ Resumen Ejecutivo

El sistema Ticketero es una soluciÃ³n completa de gestiÃ³n de colas bancarias que combina una aplicaciÃ³n Java moderna con infraestructura AWS escalable y segura.

## ğŸ¯ Objetivos de Arquitectura

- **Escalabilidad**: Manejo de picos de demanda automÃ¡tico
- **Disponibilidad**: 99.9% uptime con recuperaciÃ³n automÃ¡tica
- **Seguridad**: Credenciales seguras y red aislada
- **Observabilidad**: Monitoreo completo y alertas
- **Costo-Eficiencia**: Recursos optimizados para cada ambiente

## ğŸ—ï¸ Vista de Alto Nivel

```mermaid
graph TB
    subgraph "Internet"
        U[ğŸ‘¤ Usuario]
        T[ğŸ“± Telegram Bot]
    end
    
    subgraph "AWS Cloud"
        subgraph "Public Subnets"
            ALB[ğŸ”„ Application Load Balancer]
            NAT[ğŸŒ NAT Gateway]
        end
        
        subgraph "Private Subnets"
            ECS[ğŸ³ ECS Fargate]
            RDS[(ğŸ—„ï¸ PostgreSQL)]
            MQ[ğŸ“¨ RabbitMQ]
        end
        
        subgraph "Security & Secrets"
            SM[ğŸ” Secrets Manager]
            SG[ğŸ›¡ï¸ Security Groups]
        end
    end
    
    U --> ALB
    ALB --> ECS
    ECS --> RDS
    ECS --> MQ
    ECS --> SM
    ECS --> T
    
    style U fill:#e1f5fe
    style ALB fill:#f3e5f5
    style ECS fill:#e8f5e8
    style RDS fill:#fff3e0
    style MQ fill:#fce4ec
```

## ğŸ”§ Componentes TÃ©cnicos

### ğŸ“± AplicaciÃ³n Java

**Stack TecnolÃ³gico:**
- **Runtime**: Java 21 (LTS)
- **Framework**: Spring Boot 3.2
- **Base de Datos**: PostgreSQL 16
- **MensajerÃ­a**: RabbitMQ 3.13
- **ContainerizaciÃ³n**: Docker multi-stage

**Patrones Implementados:**
- **Outbox Pattern**: Consistencia transaccional
- **Circuit Breaker**: Resiliencia ante fallos
- **Health Checks**: Monitoreo de estado
- **Graceful Shutdown**: Cierre controlado

### ğŸ—ï¸ Infraestructura AWS

#### Red y Conectividad
```
VPC (10.0.0.0/16)
â”œâ”€â”€ Public Subnets (2 AZs)
â”‚   â”œâ”€â”€ 10.0.1.0/24 (us-east-1a)
â”‚   â””â”€â”€ 10.0.2.0/24 (us-east-1b)
â””â”€â”€ Private Subnets (2 AZs)
    â”œâ”€â”€ 10.0.3.0/24 (us-east-1a)
    â””â”€â”€ 10.0.4.0/24 (us-east-1b)
```

#### Compute y AplicaciÃ³n
- **ECS Fargate**: Serverless containers
- **Auto Scaling**: 1-3 tareas basado en CPU
- **Application Load Balancer**: DistribuciÃ³n de trÃ¡fico
- **Target Groups**: Health checks en `/actuator/health`

#### Datos y Persistencia
- **RDS PostgreSQL**: Multi-AZ para alta disponibilidad
- **Automated Backups**: 7 dÃ­as de retenciÃ³n
- **Encryption**: En trÃ¡nsito y en reposo

#### MensajerÃ­a
- **Amazon MQ**: RabbitMQ managed
- **Deployment Mode**: Single instance (dev)
- **Engine Version**: 3.13.x

## ğŸ”’ Seguridad

### Modelo de Seguridad por Capas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Internet Gateway              â”‚ â† Punto de entrada
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Application Load Balancer       â”‚ â† SSL Termination
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Security Groups               â”‚ â† Firewall de red
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          Private Subnets                â”‚ â† Aislamiento de red
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         IAM Roles & Policies            â”‚ â† Control de acceso
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          Secrets Manager                â”‚ â† GestiÃ³n de credenciales
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Security Groups

| Grupo | Protocolo | Puerto | Origen | DescripciÃ³n |
|-------|-----------|--------|--------|--------------|
| ALB-SG | TCP | 80 | 0.0.0.0/0 | HTTP pÃºblico |
| ALB-SG | TCP | 443 | 0.0.0.0/0 | HTTPS pÃºblico |
| App-SG | TCP | 8080 | ALB-SG | Solo desde ALB |
| DB-SG | TCP | 5432 | App-SG | Solo desde App |
| MQ-SG | TCP | 5671 | App-SG | Solo desde App |

### GestiÃ³n de Secretos

```yaml
Secrets Manager:
  - ticketero-dev-db-credentials:
      username: postgres
      password: <auto-generated>
      
  - ticketero-dev-mq-credentials:
      username: admin
      password: <auto-generated>
      
  - ticketero-dev-telegram-credentials:
      bot_token: <manual>
      chat_id: <manual>
```

## ğŸ“Š Flujo de Datos

### 1. CreaciÃ³n de Ticket

```mermaid
sequenceDiagram
    participant U as Usuario
    participant ALB as Load Balancer
    participant APP as AplicaciÃ³n
    participant DB as PostgreSQL
    participant MQ as RabbitMQ
    participant T as Telegram
    
    U->>ALB: POST /api/tickets
    ALB->>APP: Forward request
    
    Note over APP,DB: TransacciÃ³n ACID
    APP->>DB: INSERT ticket
    APP->>DB: INSERT outbox_message
    
    APP->>U: Ticket response
    
    Note over APP,MQ: Async processing
    APP->>MQ: Publish notification
    APP->>T: Send Telegram message
```

### 2. Consulta de Estado

```mermaid
sequenceDiagram
    participant U as Usuario
    participant ALB as Load Balancer
    participant APP as AplicaciÃ³n
    participant DB as PostgreSQL
    
    U->>ALB: GET /api/tickets/{uuid}
    ALB->>APP: Forward request
    APP->>DB: SELECT ticket
    DB->>APP: Ticket data
    APP->>ALB: JSON response
    ALB->>U: Ticket status
```

## ğŸš€ Despliegue y CI/CD

### Pipeline de Despliegue

```yaml
Stages:
  1. ğŸ§ª Test:
     - Unit tests (JUnit 5)
     - Integration tests (TestContainers)
     - Code coverage (JaCoCo)
     
  2. ğŸ”’ Security:
     - Vulnerability scan (Trivy)
     - Dependency check
     - SAST analysis
     
  3. ğŸ³ Build:
     - Docker image build
     - Multi-stage optimization
     - Image scanning
     
  4. ğŸ—ï¸ Infrastructure:
     - CDK synthesis
     - CloudFormation validation
     - Cost estimation
     
  5. ğŸš€ Deploy:
     - Infrastructure deployment
     - Application deployment
     - Smoke tests
```

### Estrategia de Ambientes

| Ambiente | PropÃ³sito | Recursos | Auto-Deploy |
|----------|-----------|----------|--------------|
| **Development** | Desarrollo activo | MÃ­nimos | âœ… main branch |
| **Staging** | Testing pre-prod | Similares a prod | ğŸ”„ Manual |
| **Production** | ProducciÃ³n | Completos | ğŸ”„ Manual + Approval |

## ğŸ“ˆ Monitoreo y Observabilidad

### MÃ©tricas Clave

```yaml
Application Metrics:
  - tickets.created.total
  - tickets.processed.duration
  - queue.size.current
  - notifications.sent.total
  
Infrastructure Metrics:
  - ecs.cpu.utilization
  - ecs.memory.utilization
  - rds.connections.count
  - alb.request.count
  
Business Metrics:
  - average.wait.time
  - customer.satisfaction
  - peak.hours.load
```

### Alertas

| MÃ©trica | Umbral | AcciÃ³n |
|---------|--------|---------|
| CPU > 80% | 5 min | Auto-scale |
| Memory > 85% | 3 min | Alert + Scale |
| Error Rate > 5% | 1 min | Immediate alert |
| DB Connections > 80% | 2 min | Alert |

## ğŸ’° OptimizaciÃ³n de Costos

### Estrategias Implementadas

1. **Right-sizing**: Instancias apropiadas por ambiente
2. **Auto Scaling**: Recursos bajo demanda
3. **Spot Instances**: Para cargas no crÃ­ticas
4. **Reserved Instances**: Para recursos base
5. **Lifecycle Policies**: Limpieza automÃ¡tica

### EstimaciÃ³n de Costos (Mensual)

| Ambiente | Compute | Database | Network | Storage | Total |
|----------|---------|----------|---------|---------|-------|
| **Dev** | $25 | $35 | $45 | $10 | **$115** |
| **Staging** | $50 | $70 | $60 | $20 | **$200** |
| **Prod** | $200 | $300 | $100 | $50 | **$650** |

## ğŸ”„ Disaster Recovery

### RTO/RPO Objetivos

- **RTO (Recovery Time Objective)**: 15 minutos
- **RPO (Recovery Point Objective)**: 5 minutos

### Estrategias

1. **Multi-AZ Deployment**: Failover automÃ¡tico
2. **Automated Backups**: Point-in-time recovery
3. **Cross-Region Replication**: Para casos crÃ­ticos
4. **Infrastructure as Code**: RecreaciÃ³n rÃ¡pida

## ğŸ“š Referencias

- [AWS Well-Architected Framework](https://aws.amazon.com/architecture/well-architected/)
- [Spring Boot Best Practices](https://spring.io/guides)
- [PostgreSQL Performance Tuning](https://www.postgresql.org/docs/current/performance-tips.html)
- [RabbitMQ Clustering Guide](https://www.rabbitmq.com/clustering.html)

---

**ğŸ“ Nota**: Esta arquitectura estÃ¡ diseÃ±ada para evolucionar. Se recomienda revisar y actualizar segÃºn las necesidades del negocio y nuevas tecnologÃ­as disponibles.